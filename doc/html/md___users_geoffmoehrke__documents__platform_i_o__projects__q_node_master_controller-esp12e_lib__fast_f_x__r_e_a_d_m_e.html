<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>FastFX: FastFX library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">FastFX
   &#160;<span id="projectnumber">1.0</span>
   </div>
   <div id="projectbrief">Fast LED Animation with FastLED</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('md___users_geoffmoehrke__documents__platform_i_o__projects__q_node_master_controller-esp12e_lib__fast_f_x__r_e_a_d_m_e.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">FastFX library </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>FastFX is an Arduino library that builds on the FastLED library for creating effects and animations for LED Strips. The principle idea behind the library is to provide a set of reusable classes/objects to create and display multiple colors/animations/etc. consistently in any sketch. Effects are written as classes/subclasses and displayed by a common controller object. By defining effects as objects, FastFX is able to provide capabilities that are common to all effects without the need to custom code them for each individual effect. These capabilities include:</p>
<ul>
<li>Automatic crossfade between "frames" - useful for smoother transitions in slower moving sequences.</li>
<li>Automatic crossfade between effects - gradual fade between effects when changing from one effect to another</li>
<li>Segments - Multiple effects shown in different segments of the same Strip</li>
<li>Transparency - One effect shown over the top of another with variable transparency (while both continue to animate)</li>
<li>Common Color/Palette Management - Color object/interface to change the look of effects without custom coding each color/combination</li>
<li>Independent timing - Each effect maintains its own independent Timer</li>
<li>Overlay Sequences - Brief animation sequences that can be show over the top of looping effects (with variable transparency). Useful for indicating events, transitions, etc. <br  />
</li>
<li>Auto-faders for dimming and transparency - allows for smooth transitions when changing brightness and/or transparency levels. Timing can be set independently for each. <br  />
</li>
</ul>
<h3><a class="anchor" id="autotoc_md1"></a>
Model</h3>
<p>The programming model for using FastFX differs slightly from coding directly with FastLED. The following is a brief description of the classes needed to create a sketch using FastFX:</p>
<p><img src="doc/images/FFX_Classes.jpg" alt="classes" class="inline"/></p>
<ul>
<li><b><a class="el" href="class_f_f_x_base.html">FFXBase</a></b> - Each effect is written as a subclass of the <a class="el" href="class_f_f_x_base.html">FFXBase</a> class. <a class="el" href="class_f_f_x_base.html">FFXBase</a> has its own timing parameters that determine how many milliseconds each "frame" will last. The smaller the interval, the faster the animation. <a class="el" href="class_f_f_x_base.html">FFXBase</a> provides two virtual methods that may be overridden. The most important is the WriteNextFrame() method. This method is used to make changes to a FastLED CRGB array (*CRGB[]) that represents the pixels to draw. The FastFX framework includes several pre-built effect classes, including the default <a class="el" href="class_solid_f_x.html">SolidFX</a> class, which represents a single static color (see FXXCoreEffects.h)</li>
<li><p class="startli"><b><a class="el" href="class_f_f_x_segment.html">FFXSegment</a></b> - A single LED strip is represented by a set of one or more segments. Each strip contains a <em>Primary</em> segment, which represents the entire strip. If effects will only be displayed along the entire strip, this is the only segment that needs to be present. If multiple effects are desired, then additional <em>secondary</em> segments may be defined. These segments may each have a different effect and each has its own <em>opacity</em> setting (0-255, 0=100% transparent, 255=100% opaque). The secondary segments do not need to cover the entire length of the primary segment. Pixels in the primary segment will always be visible unless they are covered by a secondary segment (and the secondary segment's opacity is greater than 0).</p>
<p class="startli">Each secondary segment is given a name or <em>Tag</em>, which is used to reference that segment on the controller. The controller provides 2 methods to access the individual segments - getPrimarySegment() and findSegment(String tag), each returns a pointer to the appropriate segment. Note that these pointers can be dereferenced safely without checking for NULLs, if an invalid segment name is specified for findSegment, a pointer to the primary segment will be returned. <br  />
 <img src="doc/images/segments.jpg" alt="segments" class="inline"/> </p><pre class="fragment">Each segment maintains a FFXFrameProvider object that is responsible for returning the frames to be drawn for each update.  The frame provider manages the cross fading, allocating extra buffers when needed.
</pre></li>
<li><b><a class="el" href="class_f_f_x_controller.html">FFXController</a></b> - This is the main interface for the FastFX framework. Every FastFX sketch will create an <a class="el" href="class_f_f_x_controller.html">FFXController</a> object and then use that object to define segments, start/stop effects and set various other parameters (brightness, opacity, speed, etc).</li>
</ul>
<h4><a class="anchor" id="autotoc_md2"></a>
A Few Additional Notes</h4>
<p>When I first began writing this code, I read up on Arduino coding and best practices. I've done some C++ coding int he past, but wouldn't consider myself an expert. However, I kept encountering statements like "don't use dynamic memory allocation , it will lead to fragmentation and eventually become unstable", "don't use Strings because they are a mess and will lead to memory leaks", and "Object-oriented features of C++ add too much overhead are are best avoided if you want good performance". While this is some truth in each of those statements, this became an exercise in discovering if this could be done, be stable and performant enough for my needs.</p>
<p>So far, the code has only been run on NodeMCU ESP8266 platform, and has performed will with strips up to 200 pixels. I have not tested on other chips or larger installations. I have some strips that have been running for months without any performance degradation or change in available memory, so I believe the code is pretty stable.</p>
<h3><a class="anchor" id="autotoc_md3"></a>
Tutorial &amp; Examples</h3>
<h4><a class="anchor" id="autotoc_md4"></a>
FirstLight</h4>
<p>Since each effect is a standalone class, creating a new one is a straightforward task. Taking from the "FirstLight" example code in the FastLED library, we will create a FastFX version and see how we gain additional functionality with FastFX. First we'll construct the effect class, which is always a descendant of <a class="el" href="class_f_f_x_base.html">FFXBase</a>:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">class FirstLightFX : public FFXBase {</div>
<div class="line">  public:    </div>
<div class="line">    // Constructor - provides defaults for interval, minInterval, and maxInterval</div>
<div class="line">    FirstLightFX(uint16_t initSize) : FFXBase( initSize, 10UL, 10UL, 100UL ) {</div>
<div class="line">      // currColor holds the FFXColor object used to manage colors in effects - this is a</div>
<div class="line">      // simple single-color effect using RGB colors, so we set the mode to singleCRGB</div>
<div class="line">      currColor.setColorMode( FFXColor::FXColorMode::singleCRGB );</div>
<div class="line">      // then supply it the color</div>
<div class="line">      currColor.setCRGB( CRGB::White );</div>
<div class="line">      // effect is running on a segment of the strip.</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    // Override initLeds - this method is called only once, right before the first frame is drawn</div>
<div class="line">    // Note that anything done here is not &quot;shown&quot; until after the first call to writeNextFrame()</div>
<div class="line">    virtual void initLeds( CRGB *bufLeds ) override {</div>
<div class="line">      // Clear the field</div>
<div class="line">      fill_solid( bufLeds, getNumLeds(), CRGB::Black );      </div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    // Override writeNextFrame - this is what is called for each change.  Note that the controller</div>
<div class="line">    // will only call this once for each frame, so we don&#39;t need to track anything about the Timing</div>
<div class="line">    // or coordination with other effects...just write the frame data into the passed CRGB array</div>
<div class="line">    virtual void writeNextFrame( CRGB *bufLeds ) override {</div>
<div class="line">      // fade any lit pixels to leave a trail behind the moving colored pixel</div>
<div class="line">      fadeToBlackBy( bufLeds, numLeds, 50 );</div>
<div class="line">      // set the next pixel to the current value in our FFXColor object (white, in this case)</div>
<div class="line">      bufLeds[getCurrPhase()-1] = currColor.getCRGB();</div>
<div class="line">    }</div>
<div class="line">};</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md5"></a>
Cycle and Phase</h4>
<p>Note the use of getCurrPhase() here. All effects have running counters for <em>Phase</em> and <em>Cycle</em>. The Phase counter starts at 1, and increments for each step until it reaches the number of pixels covered by that effect. This is considered one cycle. Once a cycle is completed, the phase is reset to 1. The getCurrCycle() method returns the count of how many times this has been repeated. For an effect running at an interval of 10 (milliseconds) with 100 pixels, a single phase will take 10 milliseconds, while a full cycle will take 1 second (1000 milliseconds). <br  />
</p>
<h4><a class="anchor" id="autotoc_md6"></a>
Initialization</h4>
<p>For FastLED, we need the CRGB array that represents the pixels in our strip, and we will also need a <a class="el" href="class_f_f_x_controller.html">FFXController</a> object for FastFX. So, the following 2 globals are defined:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">CRGB leds[NUM_LEDS]</div>
<div class="line">FFXController fxctrlr = FFXController();</div>
</div><!-- fragment --><p>Now we can modify the setup() function to create and initialize an instance of the <a class="el" href="class_f_f_x_controller.html">FFXController</a>, and create and add the effect to the controller:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">void setup() {</div>
<div class="line">    pinMode( 5, OUTPUT );</div>
<div class="line">    FastLED.addLeds&lt;WS2811, DATA_PIN, GRB&gt;(leds, NUM_LEDS);</div>
<div class="line">    FastLED.clear();</div>
<div class="line"> </div>
<div class="line">    fxctrlr.initialize( new FFXFastLEDPixelController( leds, NUM_LEDS ) );</div>
<div class="line">    fxctrlr.getPrimarySegment()-&gt;setFX( new FirstLightFX( NUM_LEDS ) );</div>
<div class="line">    fxctrlr.getPrimarySegment()-&gt;setBrightness( 100 );</div>
<div class="line">}</div>
</div><!-- fragment --><p>Now that we've built all of the instructions for creating the effect into our FirstLightFX class and added it to the controller, the main loop simply needs to make sure the controller continues to run:</p>
<div class="fragment"><div class="line"> {c++}</div>
<div class="line">void loop() {</div>
<div class="line">  fxctrlr.update();</div>
<div class="line">}</div>
</div><!-- fragment --><p>The full code can be found in <a href="examples/FFXFirstLight_A.ino">examples/FFXFirstLight_A.ino</a>. <br  />
</p>
<h4><a class="anchor" id="autotoc_md7"></a>
Speed and Cross-fade</h4>
<p>When running this example, note that you may select a different interval value to control the speed of the animation. Thas may be done by calling: </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">fxctrlr.getPrimarySegment()-&gt;getFX().setInterval( newInterval );</div>
</div><!-- fragment --><p>The interval may be changed any time after creating the effect. By using a larger interval (200+ milliseconds), you may notice that the leading white dot fades in over the duration of that interval to make the animation smoother. This is because crossfading is enabled by default by the framework. The extra buffers and frame-blending are all done automatically. This can be disabled on any individual effect by calling </p><div class="fragment"><div class="line"> {c++}</div>
<div class="line">fxctrlr.getPrimarySegment()-&gt;getFrameProvider()-&gt;setCrossFade(false)</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md8"></a>
MovementType</h4>
<p>In the above example, the movement is uni-directional - in only goes from low to high and starts over. All FastFX effect have a MovementType setting, which can be set using setMovement() and inspected using getMovement(). This may be used to support more flexible patterns of motion without having to code each individually. The Phase of the effect can be inspected normally through getCurrPhase(), but it may also be interpreted through getMovementPhase(), which will interpret the Phase in respect to the MovementType setting on the effect as follows:</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone">MovementType </th><th class="markdownTableHeadNone">MovementPhase  </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MVT_FORWARD </td><td class="markdownTableBodyNone">The phase increments normally and resets to 1 at the end of each cycle.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MVT_BACKWARD </td><td class="markdownTableBodyNone">The phase is reversed, starting at the highest value and resetting at 1.  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MVT_BACKFORTH </td><td class="markdownTableBodyNone">The phase switches between forward and backward for alternating cycles.  </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">MVT_RANDOM </td><td class="markdownTableBodyNone">The phase is a random value between 1 and the highest phase (number of LEDs in the segment)  </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">MVT_STILL </td><td class="markdownTableBodyNone">The phase never changes - always returns 1.  </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.17 </li>
  </ul>
</div>
</body>
</html>
